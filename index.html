<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–∑–≤—É—á–∫–∞ –°—Ü–µ–Ω–∞—Ä–∏–µ–≤ - –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ì–æ–ª–æ—Å</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141937;
            --bg-card: #1a1f3a;
            --accent-primary: #00d4ff;
            --accent-secondary: #7c3aed;
            --text-primary: #e8eaf0;
            --text-secondary: #9ca3bc;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Sora', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(124, 58, 237, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 212, 255, 0.15) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            width: 100%;
            background: var(--bg-card);
            border-radius: 24px;
            padding: 48px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 40px;
            font-weight: 300;
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(0, 212, 255, 0.2);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 24px;
        }

        .input-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-primary);
            font-family: 'Sora', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.1);
        }

        textarea::placeholder {
            color: var(--text-secondary);
        }

        .voice-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        select {
            padding: 14px 18px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'Sora', sans-serif;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.1);
        }

        .controls {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 200px;
            padding: 18px 32px;
            font-family: 'Sora', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        button:hover::before {
            opacity: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            box-shadow: 0 4px 16px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(0, 212, 255, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            border-color: var(--accent-primary);
            background: rgba(0, 212, 255, 0.1);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-container {
            margin-top: 32px;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            display: none;
        }

        .progress-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .status {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .audio-player {
            margin-top: 24px;
            padding: 20px;
            background: var(--bg-primary);
            border-radius: 12px;
            display: none;
        }

        .audio-player.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        audio {
            width: 100%;
            outline: none;
        }

        .info-box {
            margin-top: 32px;
            padding: 20px;
            background: rgba(0, 212, 255, 0.05);
            border-left: 4px solid var(--accent-primary);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .info-box strong {
            color: var(--accent-primary);
        }

        .warning-box {
            margin-top: 16px;
            padding: 16px;
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .container {
                padding: 32px 24px;
            }

            h1 {
                font-size: 2rem;
            }

            .voice-selector {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è –û–∑–≤—É—á–∫–∞ –°—Ü–µ–Ω–∞—Ä–∏–µ–≤</h1>
        <p class="subtitle">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≥–æ–ª–æ—Å AI</p>
        <span class="badge">‚ú® 100% –ë–µ—Å–ø–ª–∞—Ç–Ω–æ ‚Ä¢ –ë–µ–∑ API –∫–ª—é—á–µ–π</span>

        <div class="input-group">
            <label for="script">–í–∞—à —Å—Ü–µ–Ω–∞—Ä–∏–π</label>
            <textarea 
                id="script" 
                placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –≤–∞—à–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è —Å—é–¥–∞...

–ù–∞–ø—Ä–∏–º–µ—Ä:
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä, –≥–¥–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è —Å —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ–º. –°–µ–≥–æ–¥–Ω—è –º—ã —Ä–∞—Å—Å–∫–∞–∂–µ–º –≤–∞–º —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –æ —Ç–æ–º, –∫–∞–∫ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –º–µ–Ω—è–µ—Ç –Ω–∞—à—É –∂–∏–∑–Ω—å..."></textarea>
        </div>

        <div class="voice-selector">
            <div class="input-group">
                <label for="voiceSelect">–í—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞</label>
                <select id="voiceSelect">
                    <option value="male">–ú—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å</option>
                    <option value="female">–ñ–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å</option>
                </select>
            </div>
            <div class="input-group">
                <label for="rate">–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏</label>
                <select id="rate">
                    <option value="-25%">–ú–µ–¥–ª–µ–Ω–Ω–æ</option>
                    <option value="-10%">–ß—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ</option>
                    <option value="+0%" selected>–ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
                    <option value="+10%">–ß—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ</option>
                    <option value="+25%">–ë—ã—Å—Ç—Ä–æ</option>
                </select>
            </div>
        </div>

        <div class="controls">
            <button id="generateBtn" class="btn-primary">
                –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–∑–≤—É—á–∫—É
            </button>
            <button id="downloadBtn" class="btn-secondary" disabled>
                –°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ
            </button>
        </div>

        <div id="progressContainer" class="progress-container">
            <div class="status">
                <div class="spinner"></div>
                <span id="statusText">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ...</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>

        <div id="audioPlayer" class="audio-player">
            <audio id="audio" controls></audio>
        </div>

        <div class="info-box">
            <strong>‚ú® –ü–æ–ª–Ω–æ—Å—Ç—å—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ!</strong><br><br>
            
            –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö TTS —Å–µ—Ä–≤–∏—Å–æ–≤:<br>
            ‚Ä¢ <strong>VoiceRSS</strong> - –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ (—Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)<br>
            ‚Ä¢ <strong>Google TTS</strong> - —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥<br>
            ‚Ä¢ <strong>Web Speech API</strong> - –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–∏–Ω—Ç–µ–∑<br><br>
            
            –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ª—É—á—à–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –º–µ—Ç–æ–¥.<br><br>
            
            <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong><br>
            ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: "–ù–æ—Ä–º–∞–ª—å–Ω–æ"<br>
            ‚Ä¢ –î–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–∫—Å—Ç—ã –¥–æ 5000 —Å–∏–º–≤–æ–ª–æ–≤<br>
            ‚Ä¢ –¢–µ–∫—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —á–∞—Å—Ç–∏<br>
            ‚Ä¢ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ WAV (–≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ, –º–æ–∂–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ MP3)
        </div>

        <div class="warning-box">
            ‚ö†Ô∏è –°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ API. –ü—Ä–∏ –±–æ–ª—å—à–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –≤–æ–∑–º–æ–∂–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è. 
            –ï—Å–ª–∏ –æ–¥–∏–Ω –º–µ—Ç–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π.
        </div>
    </div>

    <script>
        const scriptTextarea = document.getElementById('script');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateSelect = document.getElementById('rate');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const statusText = document.getElementById('statusText');
        const audioPlayer = document.getElementById('audioPlayer');
        const audio = document.getElementById('audio');

        let audioBlob = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ TTS —á–µ—Ä–µ–∑ VoiceRSS (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π API)
        async function generateVoiceRSS(text, voice, rate) {
            // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–µ–º–æ –∫–ª—é—á (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π)
            const apiKey = ''; // –û—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º, —Ç–∞–∫ –∫–∞–∫ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
            
            const rateMap = {
                '-25%': '-3',
                '-10%': '-1',
                '+0%': '0',
                '+10%': '1',
                '+25%': '3'
            };
            
            const speed = rateMap[rate] || '0';
            
            // VoiceRSS API
            const url = `https://api.voicerss.org/?key=demo&hl=ru-ru&c=MP3&f=44khz_16bit_mono&src=${encodeURIComponent(text)}&r=${speed}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error('VoiceRSS API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            }

            return await response.arrayBuffer();
        }

        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —á–µ—Ä–µ–∑ gTTS (Google TTS)
        async function generateGoogleTTS(text) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π Google Translate TTS
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&tl=ru&client=tw-ob&q=${encodeURIComponent(text)}`;
            
            const response = await fetch(url, {
                mode: 'cors',
                headers: {
                    'User-Agent': 'Mozilla/5.0',
                    'Referer': 'https://translate.google.com/'
                }
            });
            
            if (!response.ok) {
                throw new Error('Google TTS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            }

            return await response.arrayBuffer();
        }
        
        // –†–µ–∑–µ—Ä–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —á–µ—Ä–µ–∑ Web Speech API —Å –∑–∞–ø–∏—Å—å—é
        async function generateWebSpeech(text, voiceGender, rate) {
            return new Promise((resolve, reject) => {
                // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const dest = audioContext.createMediaStreamDestination();
                const mediaRecorder = new MediaRecorder(dest.stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                const chunks = [];

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) chunks.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    const arrayBuffer = await blob.arrayBuffer();
                    resolve(arrayBuffer);
                };

                // –°–æ–∑–¥–∞–µ–º utterance
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = speechSynthesis.getVoices();
                
                // –í—ã–±–∏—Ä–∞–µ–º —Ä—É—Å—Å–∫–∏–π –≥–æ–ª–æ—Å –Ω—É–∂–Ω–æ–≥–æ –ø–æ–ª–∞
                let selectedVoice = voices.find(v => 
                    v.lang.startsWith('ru') && 
                    (voiceGender === 'male' ? 
                        (v.name.toLowerCase().includes('male') || v.name.toLowerCase().includes('–º—É–∂—Å–∫–æ–π') || v.name.toLowerCase().includes('yuri') || v.name.toLowerCase().includes('dmitry')) :
                        (v.name.toLowerCase().includes('female') || v.name.toLowerCase().includes('–∂–µ–Ω—Å–∫–∏–π') || v.name.toLowerCase().includes('tatyana') || v.name.toLowerCase().includes('svetlana'))
                    )
                );
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –Ω—É–∂–Ω—ã–π –ø–æ–ª, –±–µ—Ä—ë–º –ª—é–±–æ–π —Ä—É—Å—Å–∫–∏–π
                if (!selectedVoice) {
                    selectedVoice = voices.find(v => v.lang.startsWith('ru'));
                }
                
                if (selectedVoice) utterance.voice = selectedVoice;
                utterance.lang = 'ru-RU';
                
                const rateMap = {
                    '-25%': 0.75,
                    '-10%': 0.9,
                    '+0%': 1.0,
                    '+10%': 1.1,
                    '+25%': 1.25
                };
                utterance.rate = rateMap[rate] || 1.0;
                utterance.pitch = voiceGender === 'male' ? 0.9 : 1.1;

                mediaRecorder.start();

                utterance.onend = () => {
                    setTimeout(() => mediaRecorder.stop(), 200);
                };

                utterance.onerror = (e) => {
                    mediaRecorder.stop();
                    reject(e);
                };

                speechSynthesis.cancel();
                speechSynthesis.speak(utterance);
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–æ–ª–æ—Å–∞ –¥–ª—è Web Speech API
        if (speechSynthesis) {
            speechSynthesis.getVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
            }
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        generateBtn.addEventListener('click', async () => {
            const text = scriptTextarea.value.trim();
            const voice = voiceSelect.value;
            const rate = rateSelect.value;

            if (!text) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è');
                return;
            }

            generateBtn.disabled = true;
            downloadBtn.disabled = true;
            progressContainer.classList.add('active');
            audioPlayer.classList.remove('active');
            progressFill.style.width = '0%';
            statusText.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';

            try {
                // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏
                const chunks = splitTextIntoChunks(text, 300);
                const audioChunks = [];

                for (let i = 0; i < chunks.length; i++) {
                    statusText.textContent = `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–∞—Å—Ç–∏ ${i + 1} –∏–∑ ${chunks.length}...`;
                    progressFill.style.width = `${((i + 1) / chunks.length) * 90}%`;

                    let audioData = null;
                    let method = 'unknown';

                    // –ü—Ä–æ–±—É–µ–º –º–µ—Ç–æ–¥—ã –ø–æ –ø–æ—Ä—è–¥–∫—É
                    try {
                        // –ú–µ—Ç–æ–¥ 1: VoiceRSS (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)
                        audioData = await generateVoiceRSS(chunks[i], voice, rate);
                        method = 'VoiceRSS';
                    } catch (e1) {
                        console.warn('VoiceRSS failed:', e1);
                        try {
                            // –ú–µ—Ç–æ–¥ 2: Google TTS (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, —Å—Ä–µ–¥–Ω–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)
                            audioData = await generateGoogleTTS(chunks[i]);
                            method = 'Google TTS';
                        } catch (e2) {
                            console.warn('Google TTS failed:', e2);
                            // –ú–µ—Ç–æ–¥ 3: Web Speech API (–ª–æ–∫–∞–ª—å–Ω—ã–π, –∫–∞—á–µ—Å—Ç–≤–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∏—Å—Ç–µ–º—ã)
                            audioData = await generateWebSpeech(chunks[i], voice, rate);
                            method = 'Web Speech';
                        }
                    }

                    if (audioData) {
                        audioChunks.push(audioData);
                        console.log(`Chunk ${i + 1} generated using ${method}`);
                    } else {
                        throw new Error('All TTS methods failed');
                    }

                    // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è rate limiting
                    if (i < chunks.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                }

                statusText.textContent = '–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∞—É–¥–∏–æ...';
                progressFill.style.width = '95%';

                // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—ä–µ–¥–∏–Ω—è–µ–º –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ Web Audio API
                const finalAudio = await mergeAudioProperly(audioChunks);
                audioBlob = finalAudio;

                const audioUrl = URL.createObjectURL(audioBlob);
                audio.src = audioUrl;

                progressFill.style.width = '100%';
                statusText.textContent = '–ì–æ—Ç–æ–≤–æ!';
                
                setTimeout(() => {
                    progressContainer.classList.remove('active');
                    audioPlayer.classList.add('active');
                    downloadBtn.disabled = false;
                }, 500);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ.\n\n';
                
                if (error.message.includes('–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å')) {
                    errorMessage += '–ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö.\n';
                    errorMessage += '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n';
                    errorMessage += '‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç\n';
                    errorMessage += '‚Ä¢ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ\n';
                    errorMessage += '‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ';
                } else if (error.message.includes('–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω')) {
                    errorMessage += 'TTS —Å–µ—Ä–≤–∏—Å—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.\n';
                    errorMessage += '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.';
                } else {
                    errorMessage += '–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n';
                    errorMessage += '‚Ä¢ –°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\n';
                    errorMessage += '‚Ä¢ –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç\n';
                    errorMessage += '‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º\n\n';
                    errorMessage += '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.';
                }
                
                alert(errorMessage);
                progressContainer.classList.remove('active');
            } finally {
                generateBtn.disabled = false;
            }
        });

        // –†–∞–∑–±–∏–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —á–∞—Å—Ç–∏
        function splitTextIntoChunks(text, maxSize) {
            if (text.length <= maxSize) return [text];

            const sentences = text.match(/[^.!?]+[.!?]+[\s]*/g) || [text];
            const chunks = [];
            let currentChunk = '';

            sentences.forEach(sentence => {
                if ((currentChunk + sentence).length > maxSize && currentChunk) {
                    chunks.push(currentChunk.trim());
                    currentChunk = sentence;
                } else {
                    currentChunk += ' ' + sentence;
                }
            });

            if (currentChunk.trim()) {
                chunks.push(currentChunk.trim());
            }

            return chunks;
        }

        // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ Web Audio API
        async function mergeAudioProperly(audioChunks) {
            if (audioChunks.length === 0) {
                throw new Error('–ù–µ—Ç –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è');
            }

            if (audioChunks.length === 1) {
                // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —á–∞–Ω–∫, –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–µ–∫–æ–¥–∏—Ä—É–µ–º –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ WAV –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                try {
                    const buffer = await audioContext.decodeAudioData(audioChunks[0].slice(0));
                    return audioBufferToWav(buffer);
                } catch (e) {
                    console.error('Error decoding single chunk:', e);
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
                    return new Blob([audioChunks[0]], { type: 'audio/mpeg' });
                }
            }

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const buffers = [];

            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —á–∞–Ω–∫ –≤ AudioBuffer
            for (let i = 0; i < audioChunks.length; i++) {
                try {
                    const buffer = await audioContext.decodeAudioData(audioChunks[i].slice(0));
                    buffers.push(buffer);
                } catch (e) {
                    console.error(`–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Å—Ç–∏ ${i + 1}:`, e);
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –±–∏—Ç—ã–µ —á–∞–Ω–∫–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
                }
            }

            if (buffers.length === 0) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –Ω–∏ –æ–¥–∏–Ω –∞—É–¥–∏–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –º–µ—Ç–æ–¥.');
            }

            if (buffers.length === 1) {
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –±—É—Ñ–µ—Ä –≤ WAV
                return audioBufferToWav(buffers[0]);
            }

            // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é –¥–ª–∏–Ω—É
            const totalLength = buffers.reduce((sum, buffer) => sum + buffer.length, 0);
            const numberOfChannels = buffers[0].numberOfChannels;
            const sampleRate = buffers[0].sampleRate;

            // –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –±—É—Ñ–µ—Ä
            const mergedBuffer = audioContext.createBuffer(
                numberOfChannels,
                totalLength,
                sampleRate
            );

            // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –±—É—Ñ–µ—Ä–æ–≤
            let offset = 0;
            for (let i = 0; i < buffers.length; i++) {
                for (let channel = 0; channel < numberOfChannels; channel++) {
                    mergedBuffer.getChannelData(channel).set(
                        buffers[i].getChannelData(channel),
                        offset
                    );
                }
                offset += buffers[i].length;
            }

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ WAV
            return audioBufferToWav(mergedBuffer);
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è AudioBuffer –≤ WAV Blob
        function audioBufferToWav(buffer) {
            const numberOfChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 16;

            const bytesPerSample = bitDepth / 8;
            const blockAlign = numberOfChannels * bytesPerSample;

            const data = [];
            for (let i = 0; i < buffer.length; i++) {
                for (let channel = 0; channel < numberOfChannels; channel++) {
                    const sample = buffer.getChannelData(channel)[i];
                    const int16 = Math.max(-1, Math.min(1, sample));
                    data.push(int16 < 0 ? int16 * 0x8000 : int16 * 0x7FFF);
                }
            }

            const dataLength = data.length * bytesPerSample;
            const bufferLength = 44 + dataLength;
            const arrayBuffer = new ArrayBuffer(bufferLength);
            const view = new DataView(arrayBuffer);

            // WAV –∑–∞–≥–æ–ª–æ–≤–æ–∫
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // fmt chunk size
            view.setUint16(20, format, true);
            view.setUint16(22, numberOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true); // byte rate
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);

            // PCM –¥–∞–Ω–Ω—ã–µ
            let offset = 44;
            for (let i = 0; i < data.length; i++) {
                view.setInt16(offset, data[i], true);
                offset += 2;
            }

            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        downloadBtn.addEventListener('click', () => {
            if (!audioBlob) return;

            const url = URL.createObjectURL(audioBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø–æ —Ç–∏–ø—É blob
            const extension = audioBlob.type.includes('wav') ? 'wav' : 'mp3';
            a.download = `–æ–∑–≤—É—á–∫–∞_${Date.now()}.${extension}`;
            
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        });
    </script>
</body>
</html>
